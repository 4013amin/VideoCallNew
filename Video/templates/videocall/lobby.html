<!-- videocall/templates/videocall/lobby.html -->
<!DOCTYPE html>
<html>
<head>
    <title>Video Chat Lobby</title>
    <style>
        #video-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, 300px);
            grid-gap: 10px;
        }
        video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            background-color: black;
        }
    </style>
</head>
<body>
    <h1>Video Chat Lobby</h1>
    <div id="video-grid">
        <video id="localVideo" autoplay muted></video>
    </div>
    <button id="findPartnerBtn">Find Random Partner</button>
    <button id="endCallBtn" style="display: none;">End Call</button>

    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <script>
        const localVideo = document.getElementById('localVideo');
        const findPartnerBtn = document.getElementById('findPartnerBtn');
        const endCallBtn = document.getElementById('endCallBtn');
        let localStream;
        let peer;
        let currentCall;
        let partnerId = null;
        let ws; // WebSocket connection

        // Function to get user media
        async function getMedia() {
            try {
                localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                localVideo.srcObject = localStream;
            } catch (err) {
                console.error("Error accessing media devices: ", err);
                alert("Please allow camera and microphone access to use the video chat.");
            }
        }

        getMedia();

        // Initialize PeerJS
        function initializePeer() {
            peer = new Peer(undefined, {
                host: '/', // Use a relative path if PeerJS server is on the same domain
                port: location.port,
                path: '/peerjs' // PeerJS server path
            });

            peer.on('open', id => {
                console.log('My Peer ID:', id);
                connectWebSocket(id);
            });

            peer.on('call', call => {
                console.log('Incoming call from:', call.peer);
                call.answer(localStream);
                call.on('stream', remoteStream => {
                    addRemoteVideoStream(call.peer, remoteStream);
                });
                call.on('close', () => {
                    removeRemoteVideoStream(call.peer);
                    endCall();
                });
                currentCall = call;
                endCallBtn.style.display = 'block';
                findPartnerBtn.style.display = 'none';
            });

            peer.on('disconnected', () => {
                console.log('PeerJS disconnected, attempting to reconnect...');
                peer.reconnect();
            });

            peer.on('error', err => {
                console.error('PeerJS error:', err);
                if (err.type === 'peer-unavailable') {
                     alert('Partner left the call or is unavailable.');
                     endCall();
                }
            });
        }

        // Connect to WebSocket
        function connectWebSocket(peerId) {
            const ws_protocol = window.location.protocol === "https:" ? "wss" : "ws";
            ws = new WebSocket(
                `${ws_protocol}://${window.location.host}/ws/videocall/${peerId}/`
            );

            ws.onopen = () => {
                console.log("WebSocket connected.");
            };

            ws.onmessage = async e => {
                const data = JSON.parse(e.data);
                console.log("WebSocket message received:", data);

                if (data.type === 'partner_found') {
                    partnerId = data.partner_peer_id;
                    console.log('Partner found:', partnerId);
                    if (partnerId && localStream) {
                        makeCall(partnerId);
                    }
                } else if (data.type === 'call_ended') {
                    console.log('Call ended by partner.');
                    alert('Your partner has ended the call.');
                    endCall();
                } else if (data.type === 'no_partner_found') {
                    alert('No other users currently available. Please try again later.');
                    findPartnerBtn.disabled = false;
                }
            };

            ws.onclose = e => {
                console.log('WebSocket closed unexpectedly');
                if (!currentCall) { // Only try to reconnect if not in an active call
                     setTimeout(() => connectWebSocket(peerId), 3000); // Reconnect after 3 seconds
                }
            };

            ws.onerror = e => {
                console.error("WebSocket error:", e);
            };
        }

        initializePeer();

        // Make a call to a specific peer ID
        function makeCall(peerId) {
            if (!localStream) {
                alert("Please allow camera and microphone access first.");
                return;
            }
            console.log('Making call to:', peerId);
            const call = peer.call(peerId, localStream);
            call.on('stream', remoteStream => {
                addRemoteVideoStream(peerId, remoteStream);
            });
            call.on('close', () => {
                removeRemoteVideoStream(peerId);
                endCall();
            });
            call.on('error', err => {
                console.error('Call error:', err);
                alert('Could not connect to partner. They might have left or are unavailable.');
                endCall();
            });
            currentCall = call;
            endCallBtn.style.display = 'block';
            findPartnerBtn.style.display = 'none';
        }

        // Add remote video stream to the DOM
        function addRemoteVideoStream(peerId, stream) {
            const existingVideo = document.getElementById(`remoteVideo-${peerId}`);
            if (existingVideo) return; // Prevent adding duplicate videos

            const video = document.createElement('video');
            video.id = `remoteVideo-${peerId}`;
            video.srcObject = stream;
            video.autoplay = true;
            video.playsInline = true;
            document.getElementById('video-grid').append(video);
        }

        // Remove remote video stream from the DOM
        function removeRemoteVideoStream(peerId) {
            const video = document.getElementById(`remoteVideo-${peerId}`);
            if (video) {
                video.remove();
            }
        }

        // End the current call
        function endCall() {
            if (currentCall) {
                currentCall.close();
                currentCall = null;
            }
            if (partnerId) {
                removeRemoteVideoStream(partnerId);
                partnerId = null;
                if (ws && ws.readyState === WebSocket.OPEN) {
                     ws.send(JSON.stringify({
                         'type': 'end_call'
                     }));
                }
            }
            endCallBtn.style.display = 'none';
            findPartnerBtn.style.display = 'block';
            findPartnerBtn.disabled = false;
            console.log('Call ended.');
        }

        findPartnerBtn.addEventListener('click', () => {
            findPartnerBtn.disabled = true;
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                    'type': 'find_partner'
                }));
            } else {
                alert('WebSocket not connected. Please refresh the page.');
                findPartnerBtn.disabled = false;
            }
        });

        endCallBtn.addEventListener('click', () => {
            endCall();
        });

        // Handle page unload/close
        window.addEventListener('beforeunload', () => {
            if (ws && ws.readyState === WebSocket.OPEN) {
                 ws.close();
            }
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
            }
            if (peer) {
                peer.destroy();
            }
        });
    </script>
</body>
</html>