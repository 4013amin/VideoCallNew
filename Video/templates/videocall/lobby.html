<!-- videocall/templates/videocall/lobby.html -->
<!DOCTYPE html>
<html>
<head>
    <title>Video Chat Lobby</title>
    <style>
        body { font-family: sans-serif; background-color: #f0f2f5; color: #333; text-align: center; padding-top: 20px; }
        h1 { color: #1a73e8; }
        #video-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            grid-gap: 20px;
            max-width: 1200px;
            margin: 20px auto;
        }
        video {
            width: 100%;
            height: auto;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            background-color: black;
        }
        button {
            padding: 12px 24px;
            font-size: 16px;
            cursor: pointer;
            border: none;
            border-radius: 5px;
            color: white;
            margin: 10px;
            transition: background-color 0.3s;
        }
        #findPartnerBtn { background-color: #34a853; }
        #findPartnerBtn:hover { background-color: #2c8b46; }
        #findPartnerBtn:disabled { background-color: #9e9e9e; cursor: not-allowed; }
        #endCallBtn { background-color: #ea4335; }
        #endCallBtn:hover { background-color: #c5372c; }
    </style>
</head>
<body>
    <h1>Video Chat Lobby</h1>
    <p>Welcome, {{ request.user.username }}!</p>
    <div id="video-grid">
        <video id="localVideo" autoplay muted></video>
    </div>
    <button id="findPartnerBtn">Find Random Partner</button>
    <button id="endCallBtn" style="display: none;">End Call</button>

    <!-- <<< CHANGE 1: Using the latest version of PeerJS is recommended -->
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script>
        const localVideo = document.getElementById('localVideo');
        const findPartnerBtn = document.getElementById('findPartnerBtn');
        const endCallBtn = document.getElementById('endCallBtn');
        let localStream;
        let peer;
        let currentCall;
        let partnerPeerId = null;
        let ws;

        // Function to get user media
        async function getMedia() {
            try {
                localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                localVideo.srcObject = localStream;
                // Once we have media, initialize Peer and WebSocket
                initializePeer();
            } catch (err) {
                console.error("Error accessing media devices: ", err);
                alert("Please allow camera and microphone access to use the video chat.");
            }
        }

        getMedia();

        // Initialize PeerJS
        function initializePeer() {
            // <<< CHANGE 2: Simplified PeerJS initialization.
            // By not specifying host/port, it will use the free public PeerJS cloud server.
            // This is the easiest way to get started and fixes the 'peerjs/peerjs' route error.
            peer = new Peer();

            peer.on('open', id => {
                console.log('My Peer ID:', id);
                // Connect to our Django Channels WebSocket ONLY after PeerJS is ready.
                connectWebSocket(id);
            });

            // Listen for incoming calls
            peer.on('call', call => {
                console.log('Incoming call from:', call.peer);
                // Answer the call with our local stream
                call.answer(localStream);

                call.on('stream', remoteStream => {
                    addRemoteVideoStream(call.peer, remoteStream);
                });

                call.on('close', () => {
                    console.log('The call was closed by the partner.');
                    endCall();
                });
                
                currentCall = call;
                partnerPeerId = call.peer;
                endCallBtn.style.display = 'block';
                findPartnerBtn.style.display = 'none';
            });

            peer.on('disconnected', () => {
                console.log('PeerJS disconnected. Attempting to reconnect...');
                // PeerJS handles reconnection automatically in many cases
            });

            peer.on('error', err => {
                console.error('PeerJS error:', err);
                if (err.type === 'peer-unavailable') {
                     alert('Partner left the call or is unavailable.');
                     endCall();
                }
            });
        }

        // Connect to our Django Channels WebSocket
        function connectWebSocket(peerId) {
            const ws_protocol = window.location.protocol === "https:" ? "wss" : "ws";
            // <<< CHANGE 3: The URL now matches our backend routing.py
            const wsUrl = `${ws_protocol}://${window.location.host}/ws/call/${peerId}/`;
            
            ws = new WebSocket(wsUrl);

            ws.onopen = () => {
                console.log("Application WebSocket connected successfully.");
            };

            ws.onmessage = async e => {
                const data = JSON.parse(e.data);
                console.log("WebSocket message received:", data);

                if (data.type === 'partner_found') {
                    partnerPeerId = data.partner_peer_id;
                    console.log('Partner found via WebSocket:', partnerPeerId);
                    if (partnerPeerId && localStream) {
                        makeCall(partnerPeerId);
                    }
                } else if (data.type === 'waiting_for_partner') {
                    console.log('Server says: waiting for partner...');
                    findPartnerBtn.textContent = 'Waiting for partner...';
                } else if (data.type === 'no_partner_found') {
                    alert('No other users currently available. Please try again later.');
                    findPartnerBtn.disabled = false;
                    findPartnerBtn.textContent = 'Find Random Partner';
                }
            };

            ws.onclose = e => {
                console.error('WebSocket closed unexpectedly. Code:', e.code, 'Reason:', e.reason);
            };

            ws.onerror = e => {
                console.error("WebSocket error:", e);
            };
        }

        // Make a call to a specific peer ID
        function makeCall(peerId) {
            console.log('Making call to:', peerId);
            const call = peer.call(peerId, localStream);

            call.on('stream', remoteStream => {
                addRemoteVideoStream(peerId, remoteStream);
            });

            call.on('close', () => {
                console.log('Call was closed by us or partner.');
                endCall();
            });
            
            call.on('error', err => {
                console.error('Call error:', err);
                alert('Could not connect to partner. They might have left.');
                endCall();
            });

            currentCall = call;
            endCallBtn.style.display = 'block';
            findPartnerBtn.style.display = 'none';
        }

        function addRemoteVideoStream(peerId, stream) {
            if (document.getElementById(`remoteVideo-${peerId}`)) return;
            const video = document.createElement('video');
            video.id = `remoteVideo-${peerId}`;
            video.srcObject = stream;
            video.autoplay = true;
            video.playsInline = true;
            document.getElementById('video-grid').append(video);
        }

        function removeRemoteVideoStream(peerId) {
            const video = document.getElementById(`remoteVideo-${peerId}`);
            if (video) video.remove();
        }

        function endCall() {
            if (currentCall) {
                currentCall.close();
            }
            if (partnerPeerId) {
                removeRemoteVideoStream(partnerPeerId);
                // Inform the backend that the call has ended
                if (ws && ws.readyState === WebSocket.OPEN) {
                     ws.send(JSON.stringify({ 'type': 'end_call' }));
                }
            }
            currentCall = null;
            partnerPeerId = null;
            endCallBtn.style.display = 'none';
            findPartnerBtn.style.display = 'block';
            findPartnerBtn.disabled = false;
            findPartnerBtn.textContent = 'Find Random Partner';
            console.log('Call ended locally.');
        }

        findPartnerBtn.addEventListener('click', () => {
            findPartnerBtn.disabled = true;
            findPartnerBtn.textContent = 'Searching...';
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({ 'type': 'find_partner' }));
            } else {
                alert('WebSocket is not connected. Please refresh the page.');
                findPartnerBtn.disabled = false;
                findPartnerBtn.textContent = 'Find Random Partner';
            }
        });

        endCallBtn.addEventListener('click', endCall);

        window.addEventListener('beforeunload', () => {
            if (peer) peer.destroy();
            if (ws) ws.close();
        });
    </script>
</body>
</html>