{% extends 'base.html' %}
{% load static %}

{% block title %}Video Chat Lobby{% endblock %}

{% block content %}
<div class="min-h-screen bg-slate-950 flex flex-col items-center justify-center p-4 font-sans">
    
    <div class="max-w-6xl w-full space-y-6">
        
        <!-- Header: Status & Coins -->
        <div class="flex flex-col sm:flex-row items-center justify-between bg-slate-900/80 backdrop-blur-md p-4 rounded-2xl border border-slate-800 shadow-xl">
            <!-- Left: Status -->
            <div class="flex items-center gap-3 w-full sm:w-auto">
                <div id="status-icon" class="w-10 h-10 bg-slate-700 rounded-full flex items-center justify-center transition-colors duration-300">
                    <i class="fa-solid fa-wifi text-white/50"></i>
                </div>
                <div>
                    <h1 class="text-xl font-bold text-white">Random Chat</h1>
                    <p id="connection-status" class="text-xs text-slate-400 font-mono">Initializing...</p>
                </div>
            </div>

            <!-- Right: Coins -->
            <div class="mt-4 sm:mt-0 flex items-center gap-4 bg-slate-800 px-4 py-2 rounded-xl border border-slate-700 w-full sm:w-auto justify-between sm:justify-start">
                <div class="text-right">
                    <p class="text-[10px] text-slate-400 uppercase font-bold">Your Coins</p>
                    <div class="flex items-center justify-end gap-1 text-yellow-400 font-mono text-xl font-bold">
                        <i class="fa-solid fa-coins"></i>
                        <span id="coin-count">{{ coins }}</span>
                    </div>
                </div>
                
                <form action="{% url 'purchase' %}" method="GET">
                    <button type="submit" class="bg-indigo-600 hover:bg-indigo-500 text-white text-xs font-bold py-2 px-4 rounded-lg transition shadow-lg shadow-indigo-500/20 active:scale-95">
                        + Buy
                    </button>
                </form>
            </div>
        </div>

        <!-- Main Video Area -->
        <div class="relative w-full aspect-video bg-black rounded-3xl overflow-hidden shadow-2xl border border-slate-800 group">
            
            <!-- 1. Remote Video (Full Screen) -->
            <video id="remoteVideo" class="w-full h-full object-cover hidden" autoplay playsinline></video>
            
            <!-- 2. Placeholder UI (Waiting Mode) -->
            <div id="placeholder-ui" class="absolute inset-0 flex flex-col items-center justify-center bg-slate-900 text-center z-10 transition-all duration-300">
                <div class="relative w-24 h-24 mb-6">
                    <div class="w-full h-full bg-slate-800 rounded-full flex items-center justify-center relative z-10">
                        <i class="fa-solid fa-user-astronaut text-4xl text-slate-500"></i>
                    </div>
                    <div id="search-spinner" class="absolute inset-[-4px] border-4 border-indigo-500 rounded-full border-t-transparent animate-spin hidden"></div>
                    <div id="pulse-ring" class="absolute inset-0 bg-indigo-500 rounded-full animate-ping opacity-20 hidden"></div>
                </div>
                <h3 id="status-text" class="text-white text-2xl font-bold mb-2">Ready to Start</h3>
                <p class="text-slate-400 text-sm max-w-md px-4">Click the button below to find a random partner.</p>
            </div>

            <!-- 3. Local Video (Picture in Picture) -->
            <div class="absolute top-4 right-4 w-28 sm:w-48 aspect-video bg-slate-800 rounded-xl overflow-hidden shadow-2xl border-2 border-slate-700/50 z-20 hover:scale-105 transition-transform duration-300">
                <video id="localVideo" class="w-full h-full object-cover transform -scale-x-100" autoplay muted playsinline></video>
                <div class="absolute bottom-1 right-2 text-[10px] font-bold text-white/90 bg-black/60 px-2 py-0.5 rounded backdrop-blur-sm">YOU</div>
            </div>

            <!-- 4. Controls -->
            <div class="absolute bottom-8 left-0 right-0 flex justify-center gap-4 z-30 px-4">
                <button id="findBtn" disabled class="bg-indigo-600 hover:bg-indigo-500 disabled:bg-slate-700 disabled:cursor-not-allowed text-white px-8 py-4 rounded-full font-bold shadow-xl shadow-indigo-500/30 transition-all hover:scale-105 active:scale-95 flex items-center gap-3 min-w-[200px] justify-center">
                    <i class="fa-solid fa-bolt"></i>
                    <span>Connecting...</span>
                </button>

                <button id="nextBtn" class="hidden bg-emerald-600 hover:bg-emerald-500 text-white px-8 py-4 rounded-full font-bold shadow-xl shadow-emerald-500/30 transition-all hover:scale-105 active:scale-95 flex items-center gap-3 min-w-[160px] justify-center">
                    <span>Next Person</span>
                    <i class="fa-solid fa-arrow-right"></i>
                </button>

                <button id="stopBtn" class="hidden bg-rose-600 hover:bg-rose-500 text-white w-14 h-14 rounded-full font-bold shadow-xl shadow-rose-500/30 transition-all hover:scale-110 active:scale-90 flex items-center justify-center">
                    <i class="fa-solid fa-phone-slash text-xl"></i>
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>

<script>
    const PEER_CONFIG = {
        config: {
            iceServers: [
                { url: 'stun:stun.l.google.com:19302' },
                { url: 'stun:stun1.l.google.com:19302' },
            ]
        }
    };

    const elements = {
        localVideo: document.getElementById('localVideo'),
        remoteVideo: document.getElementById('remoteVideo'),
        placeholder: document.getElementById('placeholder-ui'),
        statusText: document.getElementById('status-text'),
        spinner: document.getElementById('search-spinner'),
        pulse: document.getElementById('pulse-ring'),
        findBtn: document.getElementById('findBtn'),
        nextBtn: document.getElementById('nextBtn'),
        stopBtn: document.getElementById('stopBtn'),
        coinCount: document.getElementById('coin-count'),
        connStatus: document.getElementById('connection-status'),
        statusIcon: document.getElementById('status-icon'),
    };

    let state = {
        localStream: null,
        peer: null,
        ws: null,
        currentCall: null,
        peerId: null
    };

    async function init() {
        try {
            updateStatusUI('loading', 'Accessing Camera...');
            state.localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
            elements.localVideo.srcObject = state.localStream;

            updateStatusUI('loading', 'Connecting to Peer...');
            state.peer = new Peer(undefined, PEER_CONFIG);

            state.peer.on('open', (id) => {
                state.peerId = id;
                connectWebSocket(id);
            });

            state.peer.on('call', (call) => {
                call.answer(state.localStream);
                handleCallStream(call);
            });

            state.peer.on('error', (err) => {
                console.error(err);
                updateStatusUI('error', 'Network Error');
            });

        } catch (err) {
            updateStatusUI('error', 'Camera Denied');
        }
    }

    function connectWebSocket(peerId) {
        const protocol = window.location.protocol === "https:" ? "wss" : "ws";
        const url = `${protocol}://${window.location.host}/ws/call/${peerId}/`;
        state.ws = new WebSocket(url);

        state.ws.onopen = () => {
            updateStatusUI('ready', 'Connected & Ready');
            elements.findBtn.disabled = false;
            elements.findBtn.querySelector('span').innerText = "Start Matching";
        };

        state.ws.onmessage = (e) => {
            const data = JSON.parse(e.data);
            handleWsMessage(data);
        };
    }

    function handleWsMessage(data) {
        switch(data.type) {
            case 'waiting_in_queue':
                setUIMode('searching');
                break;
            case 'partner_found':
                setUIMode('found');
                elements.coinCount.innerText = data.coins;
                if (data.role === 'initiator') {
                    setTimeout(() => {
                        const call = state.peer.call(data.partner_peer_id, state.localStream);
                        handleCallStream(call);
                    }, 1000);
                }
                break;
            case 'out_of_coins':
                setUIMode('idle');
                alert('Not enough coins!');
                break;
        }
    }

    function handleCallStream(call) {
        state.currentCall = call;
        call.on('stream', (remoteStream) => {
            elements.remoteVideo.srcObject = remoteStream;
            setUIMode('connected');
        });
        call.on('close', () => endCall(false));
    }

    function endCall(notifyServer = true) {
        if (state.currentCall) state.currentCall.close();
        state.currentCall = null;
        elements.remoteVideo.srcObject = null;
        setUIMode('idle');
        if (notifyServer && state.ws.readyState === WebSocket.OPEN) {
            state.ws.send(JSON.stringify({ type: 'end_call' }));
        }
    }

    function setUIMode(mode) {
        elements.spinner.classList.add('hidden');
        elements.pulse.classList.add('hidden');
        elements.remoteVideo.classList.add('hidden');
        elements.placeholder.classList.remove('hidden');
        elements.findBtn.classList.add('hidden');
        elements.nextBtn.classList.add('hidden');
        elements.stopBtn.classList.add('hidden');

        if (mode === 'idle') {
            elements.findBtn.classList.remove('hidden');
            elements.statusText.innerText = "Ready to Connect";
        } else if (mode === 'searching') {
            elements.spinner.classList.remove('hidden');
            elements.statusText.innerText = "Searching...";
        } else if (mode === 'found') {
            elements.pulse.classList.remove('hidden');
            elements.statusText.innerText = "Connecting to Partner...";
        } else if (mode === 'connected') {
            elements.placeholder.classList.add('hidden');
            elements.remoteVideo.classList.remove('hidden');
            elements.nextBtn.classList.remove('hidden');
            elements.stopBtn.classList.remove('hidden');
        }
    }

    function updateStatusUI(type, msg) {
        elements.connStatus.innerText = msg;
        if (type === 'ready') {
            elements.statusIcon.innerHTML = '<i class="fa-solid fa-wifi text-emerald-400"></i>';
            elements.statusIcon.className = "w-10 h-10 bg-emerald-500/20 rounded-full flex items-center justify-center";
        } else if (type === 'error') {
            elements.statusIcon.innerHTML = '<i class="fa-solid fa-circle-exclamation text-rose-400"></i>';
            elements.statusIcon.className = "w-10 h-10 bg-rose-500/20 rounded-full flex items-center justify-center";
        } else {
            elements.statusIcon.innerHTML = '<i class="fa-solid fa-circle-notch fa-spin text-white/50"></i>';
        }
    }

    elements.findBtn.addEventListener('click', () => {
        state.ws.send(JSON.stringify({ type: 'find_partner' }));
    });

    elements.nextBtn.addEventListener('click', () => {
        endCall(true);
        setTimeout(() => state.ws.send(JSON.stringify({ type: 'find_partner' })), 500);
    });

    elements.stopBtn.addEventListener('click', () => endCall(true));

    init();
</script>
{% endblock %}