<!-- videocall/templates/videocall/lobby.html -->
<!DOCTYPE html>
<html>
<head>
    <title>Video Chat Lobby</title>
    <!-- Styles from previous answer -->
</head>
<body>
    <h1>Video Chat Lobby</h1>
    <p>Welcome, {{ request.user.username }}!</p>

    <!-- Coin Display -->
    <div id="coin-section">
        <h3>You have <span id="coin-count">{{ coins }}</span> coins.</h3>
        <form action="{% url 'add_coins' %}" method="post" style="display: inline;">
            {% csrf_token %}
            <button type="submit">Buy 5 Coins</button>
        </form>
    </div>

    <div id="video-grid">
        <video id="localVideo" autoplay muted></video>
    </div>
    <button id="findPartnerBtn">Find Random Partner</button>
    <button id="endCallBtn" style="display: none;">End Call</button>

    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script>
        const localVideo = document.getElementById('localVideo');
        const findPartnerBtn = document.getElementById('findPartnerBtn');
        const endCallBtn = document.getElementById('endCallBtn');
        const coinCountSpan = document.getElementById('coin-count');
        
        let localStream;
        let peer;
        let currentCall;
        let partnerPeerId = null;
        let ws;

        // Check initial coins
        if (parseInt(coinCountSpan.textContent) <= 0) {
            findPartnerBtn.disabled = true;
            findPartnerBtn.textContent = 'Out of Coins';
        }

        // ... (getMedia and initializePeer functions are the same as before) ...
        async function getMedia() { /* ... unchanged ... */ }
        getMedia();
        function initializePeer() { /* ... unchanged ... */ }
        
        function connectWebSocket(peerId) {
            const ws_protocol = window.location.protocol === "https:" ? "wss" : "ws";
            const wsUrl = `${ws_protocol}://${window.location.host}/ws/call/${peerId}/`;
            ws = new WebSocket(wsUrl);

            ws.onopen = () => console.log("WebSocket connected.");

            ws.onmessage = async e => {
                const data = JSON.parse(e.data);
                console.log("WebSocket message received:", data);

                switch (data.type) {
                    case 'partner_found':
                        partnerPeerId = data.partner_peer_id;
                        console.log('Partner found:', partnerPeerId);
                        makeCall(partnerPeerId);
                        break;
                    case 'waiting_for_partner':
                        findPartnerBtn.textContent = 'Waiting for partner...';
                        break;
                    case 'out_of_coins':
                        alert(data.message);
                        findPartnerBtn.disabled = true;
                        findPartnerBtn.textContent = 'Out of Coins';
                        break;
                    case 'coin_update':
                        coinCountSpan.textContent = data.coins;
                        console.log(`Coin balance updated to ${data.coins}`);
                        break;
                    case 'call_ended_by_partner':
                        alert('Your partner has ended the call.');
                        endCall();
                        break;
                }
            };

            ws.onclose = () => console.error('WebSocket closed unexpectedly.');
            ws.onerror = e => console.error("WebSocket error:", e);
        }

        function makeCall(peerId) { /* ... unchanged ... */ }
        function addRemoteVideoStream(peerId, stream) { /* ... unchanged ... */ }
        function removeRemoteVideoStream(peerId) { /* ... unchanged ... */ }

        function endCall() {
            if (currentCall) currentCall.close();
            if (partnerPeerId) removeRemoteVideoStream(partnerPeerId);
            
            if (ws && ws.readyState === WebSocket.OPEN) {
                 ws.send(JSON.stringify({ 'type': 'end_call' }));
            }

            currentCall = null;
            partnerPeerId = null;
            endCallBtn.style.display = 'none';
            findPartnerBtn.style.display = 'block';
            findPartnerBtn.disabled = parseInt(coinCountSpan.textContent) <= 0;
            findPartnerBtn.textContent = findPartnerBtn.disabled ? 'Out of Coins' : 'Find Random Partner';
            console.log('Call ended locally.');
        }

        findPartnerBtn.addEventListener('click', () => {
            if (parseInt(coinCountSpan.textContent) <= 0) {
                alert('You have no coins left!');
                return;
            }
            findPartnerBtn.disabled = true;
            findPartnerBtn.textContent = 'Searching...';
            ws.send(JSON.stringify({ 'type': 'find_partner' }));
        });

        endCallBtn.addEventListener('click', endCall);

        window.addEventListener('beforeunload', () => {
            if (peer) peer.destroy();
            if (ws) ws.close();
        });
    </script>
</body>
</html>